/**
 * @description
 * 对transport后的cmd文件进行解析，查找其子依赖和父依赖（对应缓存）
 * 并记录该文件的最后修改时间
 *
 *
 * @author pakinguo
 */

var FS = require('fs');
var PATH = require('path');
var grunt = require('grunt');
var colors = require('colors');
var JSONNICE = require('json-nice');

var MTIMEJSON = "mtime.json";

module.exports = function(fileObj, options) {
	if (!options || !options.dest) {
		console.log('[Error]: '.dest + 'options.base is required!');
		return;
	}

	var output = PATH.join(options.dest, MTIMEJSON);
	if (!FS.existsSync(output)) {
		grunt.file.write(output, '{}');
	}

	var json = require(output);
	var src = fileObj.src[0];
	var mtime = FS.statSync(src).mtime.getTime();

	if (src in json) {
		if (mtime !== json[src]) {
			json[src] = mtime;
			console.log(src + ':' + mtime)
			grunt.file.write(output, JSONNICE(json));
			return true;
		} else {
			return false;
		}
	} else {
		json[src] = mtime;
		grunt.file.write(output, JSONNICE(json));
		return false;
	}
}