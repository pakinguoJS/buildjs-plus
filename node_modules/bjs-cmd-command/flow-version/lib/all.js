/**
 * @description
 * 对transport后的cmd文件进行解析，查找其子依赖和父依赖（对应缓存）
 * 并记录该文件的最后修改时间
 *
 *
 * @author pakinguo
 */

var FS = require('fs');
var PATH = require('path');
var grunt = require('grunt');

module.exports = function(fileObj, options) {
	var src = fileObj.src[0];

	if (!options.base) {
		console.log('[Error]: '.red + 'options.base is required!');
		return;
	}

	var version;
	if (options.md5) {
		version = 'md5';
	} else {
		version = FS.statSync(src).mtime.getTime() / 1000;
	}

	var _src = fileObj.orig.src[0].replace(/\\|\\\\/g, '/');
	var pattern = _src.substring(_src.indexOf('/') + 1, _src.lastIndexOf('.'));

	// 先copy文件
	var dest = PATH.join(PATH.dirname(src), PATH.basename(src, PATH.extname(src)) + '@v' + version + PATH.extname(src)).replace(/\\|\\\\/g, '/');
	grunt.file.copy(src, dest);

	// .png .jpg .gif .bmp
	if (/\.(png|jpg|gif|bmp)$/.test(src)) {
		dispose(pattern, options, version, 'img');
	} else if (/\.css$/.test(src)) {
		// .css
		dispose(pattern, options, version, 'css');
	} else if (/\.js/.test(src)) {
		// .js
		dispose(pattern, options, version, 'js');
	} else if (/\.(html|htm|tpl)/.test(src)) {
		// .html .tpl
	}


}


function traverse(path, callback) {
	if(!FS.existsSync(path)){
		return;
	}
	var ll = FS.readdirSync(path);
	ll.forEach(function(file) {
		var _file = PATH.join(path, file);
		if (FS.statSync(_file).isDirectory()) {
			traverse(_file, callback);
		} else {
			/\.(html|htm|js|css|tpl)$/.test(_file) ? callback(_file) : null;
		}
	});
}


function dispose(pattern, options, version, type) {
	// 遍历dest所有文件，引用到对应的图片需要
	traverse(options.base, inner);
	options.view ? traverse(options.view, inner) : null;

	var regMatches, regReplace;
	switch (type) {
		case 'img':
			regMatches = /(src=["']*[^"']*\.(png|jpg|gif|bmp)["']*)|(url\([a-zA-z0-9\.\/@]+\.(png|jpg|gif|bmp)\))/g;
			regReplace = /src=|url\(|\)|["']/g;
			break;
		case 'css':
			regMatches = /(href=["'][^\s"']+\.css["']*)|['"][^\s"']+\.css['"]/g;
			regReplace = /href=|['"]/g;
			break;
		case 'js':
			regMatches = /(src=["'][^\s"']+\.js["']*)|['"][^\s"']+\.js['"]/g;
			regReplace = /src=|['"]/g;
			break;
		default:
			break;
	}

	function inner(file) {
		var mark = false;
		var content = FS.readFileSync(file, 'utf8');
		var matches = content.match(regMatches);
		if (matches && matches.length > 0) {
			matches.forEach(function(item) {
				var rpath = item.replace(regReplace, '');
				var tmp = rpath;

				// 如果是./和../的相对路径，需要合成绝对路径
				if (/^\./.test(rpath)) {
					tmp = PATH.join(PATH.dirname(file), rpath).replace(/\\|\\\\/g, '/');
				}

				// 若存在过滤过的匹配，则做回写操作
				if (tmp.indexOf(pattern) > -1) {
					content = content.replace(new RegExp(rpath.replace(/\.|\//g, '\\$&'), 'g'), PATH.dirname(rpath) + '/' + PATH.basename(pattern) + '@v' + version + PATH.extname(rpath));
					mark = true; // 标记需要回写
				}
			})
		}
		if (mark) {
			FS.writeFileSync(file, content, 'utf8');
		}
	}
}